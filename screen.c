#include <stdio.h>
#include "vfdlib.h"
#include "gpsapp.h"

#define MAX_X (VFD_WIDTH - VFD_HEIGHT)
#define MAX_Y (VFD_HEIGHT)

static struct coord map_center;
static int map_scale;

void draw_setup(unsigned char *screen, const struct coord *center,
		const int scale)
{
    map_center = *center;
    map_scale = scale;
}

static void project(const struct xy *pos, struct xy *xy)
{
    xy->x = (MAX_X / 2) + ((pos->x - map_center.xy.x) >> map_scale);
    xy->y = (MAX_Y / 2) - ((pos->y - map_center.xy.y) >> map_scale);
}

void draw_line(unsigned char *screen, const struct xy *from,
	       const struct xy *to, const int shade)
{
    struct xy fxy, txy;
    project(from, &fxy);
    project(to, &txy);
    vfdlib_drawLineClipped(screen, fxy.x, fxy.y, txy.x, txy.y, shade);
}

void draw_point(unsigned char *screen, const struct xy *coord,
		const int shade)
{
    struct xy xy;
    project(coord, &xy);
    vfdlib_drawPointClipped(screen, xy.x, xy.y, VFDSHADE_BRIGHT);
}

void draw_route(unsigned char *screen, const struct xy *pts, const int npts,
		const int shade)
{
    int i;
    struct xy last_xy, cur_xy;

    if (npts == 0) return;

    for (i = 1; i < npts; i++) {
	project(&pts[i-1], &last_xy);
	project(&pts[i], &cur_xy);

	vfdlib_drawLineClipped(screen, last_xy.x, last_xy.y,
			       cur_xy.x, cur_xy.y, shade);
    }
}

#if 0
static unsigned char *cursors[] = {
    /*?*/  "\x00\x00\x07\x00\x07\x00\x10\x38\x6c\x38\x10\x00",
    /*N*/  "\x00\x00\x07\x00\x07\x10\x38\x38\x6c\x7c\x00\x00",
    /*NNE*/"\x00\x00\x07\x00\x07\x08\x18\x38\x68\x78\x18\x00",
    /*NE*/ "\x00\x00\x07\x00\x07\x02\x0c\x3c\x68\x38\x10\x00",
    /*ENE*/"\x00\x00\x07\x00\x07\x00\x00\x7e\x6c\x38\x30\x00",
    /*E*/  "\x00\x00\x07\x00\x07\x00\x30\x3c\x2e\x3c\x30\x00",
    /*ESE*/"\x00\x00\x07\x00\x07\x00\x30\x38\x6c\x7e\x00\x00",
    /*SE*/ "\x00\x00\x07\x00\x07\x00\x10\x38\x68\x3c\x0c\x02",
    /*SSE*/"\x00\x00\x07\x00\x07\x00\x18\x78\x68\x38\x18\x08",
    /*S*/  "\x00\x00\x07\x00\x07\x00\x00\x7c\x6c\x38\x38\x10",
    /*SSW*/"\x00\x00\x07\x00\x07\x00\x30\x3c\x2c\x38\x30\x20",
    /*SW*/ "\x00\x00\x07\x00\x07\x00\x10\x38\x2c\x78\x60\x80",
    /*WSW*/"\x00\x00\x07\x00\x07\x00\x18\x38\x6c\xfc\x00\x00",
    /*W*/  "\x00\x00\x07\x00\x07\x00\x18\x78\xe8\x78\x18\x00",
    /*WNW*/"\x00\x00\x07\x00\x07\x00\x00\xfc\x6c\x38\x18\x00",
    /*NW*/ "\x00\x00\x07\x00\x07\x80\x60\x78\x2c\x38\x10\x00",
    /*NNW*/"\x00\x00\x07\x00\x07\x20\x30\x38\x2c\x3c\x30\x00",
    /*N*/  "\x00\x00\x07\x00\x07\x10\x38\x38\x6c\x7c\x00\x00",
};
#else
static unsigned char *cursors[] = {
    /*?*/  "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x08\x00\x1c\x00\x36\x00\x1c\x00\x08\x00\x00\x00\x00\x00",
    /*N*/  "\x00\x00\x09\x00\x09\x08\x00\x08\x00\x1c\x00\x1c\x00\x36\x00\x3e\x00\x00\x00\x00\x00\x00\x00",
    /*NNE*/"\x00\x00\x09\x00\x09\x00\x00\x04\x00\x0c\x00\x1c\x00\x34\x00\x3c\x00\x0c\x00\x00\x00\x00\x00",
    /*NE*/ "\x00\x00\x09\x00\x09\x00\x00\x01\x00\x06\x00\x1e\x00\x34\x00\x1c\x00\x08\x00\x00\x00\x00\x00",
    /*ENE*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x00\x00\x3f\x00\x36\x00\x1c\x00\x18\x00\x00\x00\x00\x00",
    /*E*/  "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x18\x00\x1e\x00\x17\x10\x1e\x00\x18\x00\x00\x00\x00\x00",
    /*ESE*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x18\x00\x1c\x00\x36\x00\x3f\x00\x00\x00\x00\x00\x00\x00",
    /*SE*/ "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x08\x00\x1c\x00\x34\x00\x1e\x00\x06\x00\x01\x00\x00\x00",
    /*SSE*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x0c\x00\x3c\x00\x34\x00\x1c\x00\x0c\x00\x04\x00\x00\x00",
    /*S*/  "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x00\x00\x3e\x00\x36\x00\x1c\x00\x1c\x00\x08\x00\x08\x00",
    /*SSW*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x18\x00\x1e\x00\x16\x00\x1c\x00\x18\x00\x10\x00\x00\x00",
    /*SW*/ "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x08\x00\x1c\x00\x16\x00\x3c\x00\x30\x00\x40\x00\x00\x00",
    /*WSW*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x0c\x00\x1c\x00\x36\x00\x7f\x00\x00\x00\x00\x00\x00\x00",
    /*W*/  "\x00\x00\x09\x00\x09\x00\x00\x00\x00\x0c\x00\x3c\x00\xf4\x00\x3c\x00\x0c\x00\x00\x00\x00\x00",
    /*WNW*/"\x00\x00\x09\x00\x09\x00\x00\x00\x00\x00\x00\x7e\x00\x36\x00\x1c\x00\x0c\x00\x00\x00\x00\x00",
    /*NW*/ "\x00\x00\x09\x00\x09\x00\x00\x40\x00\x30\x00\x3c\x00\x16\x00\x1c\x00\x08\x00\x00\x00\x00\x00",
    /*NNW*/"\x00\x00\x09\x00\x09\x00\x00\x10\x00\x18\x00\x1c\x00\x16\x00\x1e\x00\x18\x00\x00\x00\x00\x00",
    /*N*/  "\x00\x00\x09\x00\x09\x00\x00\x08\x00\x1c\x00\x1c\x00\x36\x00\x3e\x00\x00\x00\x00\x00\x00\x00",
};
#endif

void draw_mark(unsigned char *screen, const struct xy *pos, const int dir,
	       const int shade)
{
    struct xy xy;

    project(pos, &xy);
    _draw_mark(screen, xy.x, xy.y, dir, shade);
}

void _draw_mark(unsigned char *screen, const int x, const int y, const int dir,
		const int shade)
{
    int idx, dx, dy;

    /* basically: index = (dir + 11.25) / (360 / 16) */
    idx = ((dir << 2) + 45) / 90;
    idx++; /* first entry is for 'unknown direction' */

    if (dir == -1) idx = 0;

    dx = cursors[idx][2];
    dy = cursors[idx][4];
    vfdlib_drawBitmap(screen, cursors[idx], x - dx / 2, y - dy / 2,
		      0, 0, dx, dy, shade, 1);
}

void draw_msg(unsigned char *screen, const char *msg)
{
    int w0 = vfdlib_getTextWidth((char *)msg, 0);

    vfdlib_drawOutlineRectangleClipped(screen, (VFD_WIDTH - w0 - 4) >> 1,
					       (VFD_HEIGHT - h0 - 4) >> 1,
					       (VFD_WIDTH + w0 + 4) >> 1,
					       (VFD_HEIGHT + h0 + 4) >> 1,
					       VFDSHADE_BRIGHT);
    vfdlib_drawSolidRectangleClipped(screen, (VFD_WIDTH - w0 - 2) >> 1,
					     (VFD_HEIGHT - h0 - 2) >> 1,
					     (VFD_WIDTH + w0 + 2) >> 1,
					     (VFD_HEIGHT + h0 + 2) >> 1,
					     VFDSHADE_BLACK);
    vfdlib_drawText(screen, (char *)msg, (VFD_WIDTH - w0) >> 1,
		    (VFD_HEIGHT - h0) >> 1, 0, -1);
}

